
# migration-job
apiVersion: batch/v1
kind: Job
metadata:
  name: laravel-migration
spec:
  template:
    spec:
      containers:
      - name: laravel-migration
        image: 183631301567.dkr.ecr.eu-west-1.amazonaws.com/lamp-app:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          php artisan session:table || echo "Session table failed" && \
          php artisan migrate:fresh --seed || echo "Migration failed"
        env:
          - name: DB_CONNECTION
            valueFrom:
              configMapKeyRef:
                name: laravel-config
                key: DB_CONNECTION
          - name: DB_HOST
            valueFrom:
              configMapKeyRef:
                name: laravel-config
                key: DB_HOST
          - name: DB_PORT
            valueFrom:
              configMapKeyRef:
                name: laravel-config
                key: DB_PORT
          - name: DB_DATABASE
            valueFrom:
              configMapKeyRef:
                name: laravel-config
                key: DB_DATABASE
          - name: DB_USERNAME
            valueFrom:
              configMapKeyRef:
                name: laravel-config
                key: DB_USERNAME
          - name: DB_PASSWORD
            valueFrom:
              configMapKeyRef:
                name: laravel-config
                key: DB_PASSWORD
      restartPolicy: OnFailure